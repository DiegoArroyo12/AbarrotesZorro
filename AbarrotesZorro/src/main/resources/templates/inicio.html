<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <link th:href="@{/css/inicio.css}" rel="stylesheet">
    <title>Inicio Abarrotes</title>
</head>
<body>
<div class="sidebar">
    <img th:src="@{/img/abarrotes.png}" alt="zorro" class="logo">

    <!-- Solo para Gerente -->
    <div class="sec" sec:authorize="hasAuthority('Gerente')">
        <button th:onclick="'window.location.href=\'' + @{/} + '\''">Historial de Ventas</button>
        <button onclick="">Empleados</button>
    </div>

    <!-- Para todos los usuarios autenticados -->
    <div class="sec" sec:authorize="isAuthenticated()">
        <button onclick="mostrarSeleccionAlmacen()">Inventario</button>

        <!-- Modal oculto -->
        <div id="modalAlmacen" class="modal">
            <h2>Selecciona el almacén</h2>
            <select id="almacenSelect" class="form-control">
                <option th:each="almacen : ${almacenes}"
                        th:value="${almacen.id}"
                        th:text="${almacen.nombre}">
                </option>
            </select>
            <br>
            <button onclick="irAInventario()">Ver Inventario</button>
            <button class="cancel" onclick="cerrarModal()">Cancelar</button>
        </div>

        <h2>Cliente</h2>

        <h4 id="nombreCliente" th:text="${nombreCliente}">Nombre del Cliente</h4>

        <label class="l_cli" for="correo">Correo: </label>
        <input class="i_cli" type="email" id="correo">

        <label class="l_cli" for="telefono">Teléfono:</label>
        <input class="i_cli" type="text" id="telefono" maxlength="12" oninput="formatearTelefono(this)">

        <button class="button_cliente" onclick="buscarCliente()">Buscar Cliente</button>
        <button class="button_cliente" th:onclick="'window.location.href=\'' + @{/cliente/nuevo-cliente} + '\''">
            Nuevo Cliente
        </button>
    </div>

    <form class="side-footer" th:action="@{/custom-logout}" method="get">
        <button type="submit">Cerrar Sesión</button>
    </form>
</div>

<div class="main">
    <div class="empleado-info">
        <div>
            <h2>Almacén:</h2>
            <select name="almacenSeleccionado" id="almacenSeleccionado" class="form-control" onchange="cargarProductosPorAlmacen()">
                <option value="" disabled selected>Seleccione un almacén</option>
                <option th:each="almacen : ${almacenes}"
                        th:value="${almacen.id}"
                        th:text="${almacen.nombre}">
                </option>
            </select>
        </div>
        <div>
            <h2>Empleado:</h2>
            <h3 th:text="${nombreEmpleado}">Nombre del Empleado</h3>
        </div>
        <div>
            <h2>Caja</h2>
            <select name="cajaSeleccionada" id="cajaSeleccionada" class="form-control" onchange="registrarAccesoCaja()" disabled>
                <option value="" disabled selected>Seleccione una caja</option>
                <option th:each="caja : ${cajas}"
                        th:value="${caja.id}"
                        th:text="${caja.nombre}">
                </option>
            </select>
        </div>
    </div>
    <div class="productos">
        <!-- Plantilla para productos -->
        <div class="producto template" style="display: none;">
            <p class="nombre-producto">Nombre</p>
            <div class="precio-producto">$0</div>
            <div class="cantidad-control">
                <button class="menos">-</button>
                <span class="cantidad">0</span>
                <span>/</span>
                <span class="stock">0</span>
                <button class="mas">+</button>
            </div>
        </div>
    </div>
</div>

<div class="carrito">
    <h1>Carrito</h1>
    <ul>
        <!-- Se insertan los productos con JS -->
    </ul>
    <div class="total">Total: $0</div>
    <button class="realizar-compra" onclick="realizarCompra()">Realizar</button></div>
<script>
    const productos = [];
    const cantidades = [];

    const contenedorProductos = document.querySelector(".productos");
    const plantillaProducto = document.querySelector(".producto.template");
    const carritoLista = document.querySelector(".carrito ul");
    const totalDiv = document.querySelector(".carrito .total");

    function actualizarCarrito() {
        carritoLista.innerHTML = "";
        let total = 0;

        productos.forEach((producto, i) => {
            if (cantidades[i] > 0) {
                const li = document.createElement("li");
                li.innerHTML = `
                    <span>${producto.nombre} x${cantidades[i]}</span>
                    <span style="float: right;">$${cantidades[i] * producto.precio}</span>
                `;
                carritoLista.appendChild(li);
                total += cantidades[i] * producto.precio;
            }
        });

        totalDiv.textContent = `Total: $${total}`;
    }

    function crearProductos() {
        productos.forEach((producto, i) => {
            cantidades[i] = 0;

            const clon = plantillaProducto.cloneNode(true);
            clon.classList.remove("template");
            clon.style.display = "block";

            clon.querySelector(".nombre-producto").textContent = producto.nombre;
            clon.querySelector(".precio-producto").textContent = `$${producto.precio}`;
            clon.querySelector(".stock").textContent = producto.stock;
            const cantidadSpan = clon.querySelector(".cantidad");

            clon.querySelector(".mas").addEventListener("click", () => {
                if (cantidades[i] < producto.stock) {
                    cantidades[i]++;
                    cantidadSpan.textContent = cantidades[i];
                    actualizarCarrito();
                } else {
                    alert("No hay más stock disponible para este producto.");
                }
            });

            clon.querySelector(".menos").addEventListener("click", () => {
                if (cantidades[i] > 0) {
                    cantidades[i]--;
                    cantidadSpan.textContent = cantidades[i];
                    actualizarCarrito();
                }
            });

            contenedorProductos.appendChild(clon);
        });
    }

    function buscarCliente() {
        const correo = document.getElementById('correo').value;
        const telefono = document.getElementById('telefono').value;

        fetch(`/cliente/buscar?correo=${correo}&telefono=${telefono}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Cliente no encontrado');
                }
                return response.json();
            })
            .then(data => {
                document.getElementById('nombreCliente').textContent = data.nombre;
            })
            .catch(error => {
                console.error(error);
                alert('No se encontró el cliente.');
            });
    }

    function formatearTelefono(input) {
        // Elimina todo lo que no sea número
        let numeros = input.value.replace(/\D/g, '');

        // Aplica formato: 2 dígitos + espacio + 4 dígitos + espacio + 4 dígitos
        if (numeros.length > 10) {
            numeros = numeros.slice(0, 10); // Limita a 10 dígitos
        }

        let formateado = '';
        if (numeros.length > 0) formateado += numeros.slice(0, 2);
        if (numeros.length > 2) formateado += ' ' + numeros.slice(2, 6);
        if (numeros.length > 6) formateado += ' ' + numeros.slice(6, 10);

        input.value = formateado;
    }

    function mostrarSeleccionAlmacen() {
        document.getElementById('modalAlmacen').style.display = 'block';
    }

    function cerrarModal() {
        document.getElementById('modalAlmacen').style.display = 'none';
    }

    function irAInventario() {
        const almacen = document.getElementById('almacenSelect').value;
        window.location.href = '/inventario?idAlmacen=' + almacen;
    }

    function cargarProductosPorAlmacen() {
        const idAlmacen = document.getElementById('almacenSeleccionado').value;
        productos.length = 0;
        cantidades.length = 0;
        contenedorProductos.innerHTML = '';

        // Habilita el select de cajas
        document.getElementById('cajaSeleccionada').disabled = !idAlmacen;

        fetch(`/abarrotes/productos?idAlmacen=${idAlmacen}`)
            .then(res => res.json())
            .then(data => {
                data.forEach(p => {
                    productos.push({
                        nombre: p.nombre,
                        precio: p.precio,
                        stock: p.stock
                    });
                });
                crearProductos();
            })
            .catch(error => console.error('Error al obtener productos: ', error));
    }

    function registrarAccesoCaja() {
    const idAlmacen = document.getElementById('almacenSeleccionado').value;
    const idCaja = document.getElementById('cajaSeleccionada').value;

    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

    fetch('/registro-acceso', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            [csrfHeader]: csrfToken
        },
        body: 'idAlmacen=' + encodeURIComponent(idAlmacen) + '&idCaja=' + encodeURIComponent(idCaja)
        }).then(response => {
            console.log("Status: ", response.status);
            return response.text();
        }).then(text => {
            console.log("Respuesta: ", text);
        }).catch(error => {
            console.error("Error de red al registrar acceso: ", error);
        });
    }
    function realizarCompra() {
        const productosCompra = productos.map((producto, i) => ({
            nombre: producto.nombre,
            precio: producto.precio,
            cantidad: cantidades[i]
        })).filter(p => p.cantidad > 0);

        if (productosCompra.length === 0) {
            alert("El carrito está vacío.");
            return;
        }

        fetch('/detalle-venta', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                [document.querySelector('meta[name="_csrf_header"]').getAttribute('content')]:
                    document.querySelector('meta[name="_csrf"]').getAttribute('content')
            },
            body: JSON.stringify(productosCompra)
        })
            .then(response => response.text())
            .then(html => {
                const nuevaVentana = window.open("", "_blank");
                nuevaVentana.document.write(html);
                nuevaVentana.document.close();
            })
            .catch(err => {
                console.error('Error al realizar compra:', err);
                alert("Error al realizar la compra.");
            });
    }
</script>
</body>
</html>